CREATE DATABASE LeMarconnesDB;
GO

USE LeMarconnesDB;
GO


CREATE TABLE AccommodatieType (
    AccommodatieTypeId INT PRIMARY KEY,
    Naam NVARCHAR(20) NOT NULL
);

INSERT INTO AccommodatieType (AccommodatieTypeId, Naam) VALUES
(1, 'Camping'),
(2, 'GÃ®te'),
(3, 'Hotel');
GO


CREATE TABLE Accommodatie (
    AccommodatieId INT PRIMARY KEY IDENTITY(1,1),
    AccommodatieTypeId INT NOT NULL FOREIGN KEY REFERENCES AccommodatieType(AccommodatieTypeId), 
    PlaatsNummer NVARCHAR(10) NOT NULL, 
    Capaciteit INT NOT NULL, 
    Status NVARCHAR(20) DEFAULT 'Beschikbaar' 
);

INSERT INTO Accommodatie (AccommodatieTypeId, PlaatsNummer, Capaciteit) VALUES
(1, '1', 6),
(1, '2', 4); 
GO


CREATE TABLE Klant (
    KlantId INT PRIMARY KEY IDENTITY(1,1),
    Voornaam NVARCHAR(50) NOT NULL,
    Tussenvoegsel NVARCHAR(20),
    Achternaam NVARCHAR(50) NOT NULL,
    Email NVARCHAR(100),
    Telefoonnummer NVARCHAR(20),
    Adres NVARCHAR(200) NULL, 
    RegistratieDatum DATETIME DEFAULT GETDATE()
);

INSERT INTO Klant (Voornaam, Tussenvoegsel, Achternaam, Email, Telefoonnummer, Adres) VALUES
('Jan', '', 'Jansen', 'jan@voorbeeld.nl', '0612345678', 'Hoofdstraat 1, Amsterdam'),
('Marie', 'de', 'Vries', 'marie@voorbeeld.nl', '0623456789', 'Dorpsweg 23, Utrecht');
GO


CREATE TABLE Tarief (
    TariefId INT PRIMARY KEY IDENTITY(1,1),
    AccommodatieTypeId INT NOT NULL FOREIGN KEY REFERENCES AccommodatieType(AccommodatieTypeId),
    Type NVARCHAR(30) NOT NULL,
    Prijs DECIMAL(10,2) NOT NULL,
    CONSTRAINT UQ_TariefTypePerAccommodatie UNIQUE(AccommodatieTypeId, Type)
);

INSERT INTO Tarief (AccommodatieTypeId, Type, Prijs) VALUES
(1, 'Campingplaats', 7.50),
(1, 'Volwassene', 6.00),
(1, 'Kind_0_7', 4.00),
(1, 'Kind_7_12', 5.00),
(1, 'Hond', 2.50),
(1, 'Electriciteit', 7.50),
(1, 'Toeristenbelasting', 0.25);
GO


CREATE TABLE Reservering (
    ReserveringId INT PRIMARY KEY IDENTITY(1,1),
    KlantId INT NOT NULL FOREIGN KEY REFERENCES Klant(KlantId),
    AccommodatieId INT NOT NULL FOREIGN KEY REFERENCES Accommodatie(AccommodatieId),
    StartDatum DATE NOT NULL,
    EindDatum DATE NOT NULL,
    AantalVolwassenen INT DEFAULT 1,
    AantalKinderen0_7 INT DEFAULT 0,
    AantalKinderen7_12 INT DEFAULT 0,
    AantalHonden INT DEFAULT 0, 
    HeeftElectriciteit BIT DEFAULT 0, 
    AantalDagenElectriciteit INT DEFAULT 0,
    TotaalPrijs DECIMAL(10,2) NOT NULL,
    Status NVARCHAR(20) DEFAULT 'Gereserveerd',
    RegistratieDatum DATETIME DEFAULT GETDATE(),
    CONSTRAINT CHK_EindNaStart CHECK (EindDatum > StartDatum)
);

INSERT INTO Reservering 
(KlantId, AccommodatieId, StartDatum, EindDatum, AantalVolwassenen, AantalKinderen0_7, 
 AantalKinderen7_12, AantalHonden, HeeftElectriciteit, AantalDagenElectriciteit, TotaalPrijs) VALUES
(1, 1, '2025-12-03', '2025-12-07', 2, 0, 1, 1, 1, 3, 127.50),
(2, 2, '2025-12-10', '2025-12-15', 4, 0, 2, 0, 1, 5, 195.00);
GO


CREATE TABLE Account (
    AccountId INT PRIMARY KEY IDENTITY(1,1),
    Gebruikersnaam NVARCHAR(50) NOT NULL UNIQUE,
    WachtwoordHash NVARCHAR(255) NOT NULL,
    Rol NVARCHAR(20) DEFAULT 'Klant',
    KlantId INT NULL FOREIGN KEY REFERENCES Klant(KlantId),  
    IsActief BIT DEFAULT 1,
    RegistratieDatum DATETIME DEFAULT GETDATE()
);

INSERT INTO Account (Gebruikersnaam, WachtwoordHash, Rol, KlantId) VALUES
('jan.jansen', 'wachtwoord', 'Klant', 1),
('marie.devries', 'wachtwoord', 'Klant', 2);
GO


CREATE PROCEDURE sp_UpdateReserveringStatussen
AS
BEGIN
    SET NOCOUNT ON;
    
    UPDATE Reservering 
    SET Status = 
        CASE 
            WHEN GETDATE() < StartDatum THEN 'Gereserveerd'
            WHEN GETDATE() BETWEEN StartDatum AND EindDatum THEN 'Actief'
            ELSE 'Verlopen'
        END
    WHERE Status != 
        CASE 
            WHEN GETDATE() < StartDatum THEN 'Gereserveerd'
            WHEN GETDATE() BETWEEN StartDatum AND EindDatum THEN 'Actief'
            ELSE 'Verlopen'
        END
    
    PRINT CONCAT('Statussen bijgewerkt op: ', GETDATE());
END
GO

EXEC sp_UpdateReserveringStatussen;
GO
